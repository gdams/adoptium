"use strict";(self.webpackChunkadoptium_website=self.webpackChunkadoptium_website||[]).push([[5552],{4748:function(e,a,n){n.r(a),n.d(a,{Head:function(){return v},default:function(){return y},formatDiv:function(){return k}});var t=n(8453),s=n(6540);function i(e){const a=Object.assign({h2:"h2",p:"p",em:"em",h3:"h3",ol:"ol",li:"li",span:"span",a:"a"},(0,t.RP)(),e.components);return s.createElement(s.Fragment,null,s.createElement(a.h2,null,"1. Background"),"\n",s.createElement(a.p,null,"Java applications are expected to start quickly because of the advent of the cloud-native era. It is becoming increasingly popular to reduce resource costs by dynamically scaling and using serverless computing. Alibaba has done a lot of work and exploration to meet the demands for quick start of applications in Serverless computing scenarios, including AppCDS, Ahead of Time Compilation (AOT), fast class indexing (JarIndex), class pre-initialization, and other technologies to optimize language runtime. Users can obtain up to three times the startup performance improvement without modifying any code. One of the cutting-edge technologies is ",s.createElement(a.em,null,"class pre-initialization"),"."),"\n",s.createElement(a.h2,null,"2. Class Pre-Initialization"),"\n",s.createElement(a.h3,null,"2.1 Motivation"),"\n",s.createElement(a.p,null,"Profiling data on Java startup stage shows that the main reason for Javas’ slow startup is that it takes much time to load, link, and initialize classes, which we aim to break one by one."),"\n",s.createElement(a.ol,null,"\n",s.createElement(a.li,null,"Class finding: Fast class indexing can find corresponding Jar file of class in O(1) time"),"\n",s.createElement(a.li,null,"Class loading and linkage: The help of AppCDS technology can reduce time consumption and speed up the startup for load and link operations."),"\n",s.createElement(a.li,null,"Class initialization: For the initialization, we observed that if the initialization of classes has no side effects, it is possible to skip the execution of the initialization of these classes. Consider the following code:"),"\n"),"\n",s.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>\n  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> cache<span class="token punctuation">;</span>\n  <span class="token keyword">static</span> <span class="token punctuation">{</span>\n    cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",s.createElement(a.p,null,"No matter when, no matter how many times, the result of initialization of the Foo class is the same: creating a hash table with a size of 1024 as a cache will not affect the external environment. In such cases, we can apply class pre-initialization, i.e. dump cache objects into CDS images, and directly map cache objects in CDS images to the Java G1 heap when JVM starts (",s.createElement(a.a,{href:"https://bugs.openjdk.org/browse/JDK-8042668"},"8042668: Provide GC support for shared heap ranges in Class Data Sharing"),"). When the program runs, skip the static code block initialization of the Foo class to speed up the startup:"),"\n",s.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>\n  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> cache<span class="token punctuation">;</span> <span class="token comment">// materialized from G1 archive region</span>\n  <span class="token keyword">static</span> <span class="token punctuation">{</span>\n    <span class="token comment">// skip execution</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",s.createElement(a.p,null,"Another classical example is ",s.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">java.lang.Integer$IntegerCache</code>'}})," class. It is an excellent candidate for class pre-initialization, which always creates a range of integer cache in [-128,127]."),"\n",s.createElement(a.h3,null,"2.2 How does it work"),"\n",s.createElement(a.p,null,"The native class pre-initialization mechanism requires explicit insertions of object materialization calls (",s.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">jdk.internal.misc.VM.initializeFromArchive(...)</code>'}}),") on certain initialization points and only supports a few restricted classes, which are hard-coded in the JVM code and cannot be extended. Alibaba and Google have proposed the ",s.createElement(a.a,{href:"https://github.com/adoptium/jdk11u-fast-startup-incubator"},"Eclipse Adoptium FastStartup Incubator project"),". They aim to explore the Java quick start technologies, including (but not limited to) class pre-initialization. As aforementioned requirements, only the initialization phase that does not take extra side effects is able to apply class pre-initialization. Alibaba and Google have explored and contributed two approaches for safe and flexible class pre-initialization."),"\n",s.createElement(a.ol,null,"\n",s.createElement(a.li,null,"Provide a Java annotation (",s.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">jdk.internal.vm.annotation.Preserve</code>'}}),"), which allows more safe classes to be pre-initialized through manual labeling."),"\n",s.createElement(a.li,null,"Add a new JVM option to accept a list of safe classes. This file can be generated by static analysis tools. This tool is based on GraalVM, it scans all class initialization code blocks and constructs their call graph, and does further data-flow analysis on that."),"\n"),"\n",s.createElement(a.p,null,"At the same time, we have added a security check mechanism of class pre-initialization to the JVM to ensure the virtual machine can still work normally in the worst case. The whole workflow is shown in the figure below:"),"\n",s.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/17669f0ded66811bfb3c6e3b71fa1b79/9f7d8/workflow.jpg"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 85%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAGAABAQADAAAAAAAAAAAAAAAAAAIBAwX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB72uxTCAAX//EABgQAAIDAAAAAAAAAAAAAAAAAAARARAg/9oACAEBAAEFAiG6Wf/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABcQAAMBAAAAAAAAAAAAAAAAAAAwMaH/2gAIAQEABj8CJqP/xAAaEAACAgMAAAAAAAAAAAAAAAABIQARECAx/9oACAEBAAE/ITcPpXBxChr/AP/aAAwDAQACAAMAAAAQ4+/8/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFhEAAwAAAAAAAAAAAAAAAAAAABAR/9oACAECAQE/ECv/xAAcEAEAAgEFAAAAAAAAAAAAAAABABEhEDFBUaH/2gAIAQEAAT8QFinHMWQj3R80FKZgLQlpDaEZ/9k=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="workflow"\n        title=""\n        src="/static/17669f0ded66811bfb3c6e3b71fa1b79/80e3c/workflow.jpg"\n        srcset="/static/17669f0ded66811bfb3c6e3b71fa1b79/4ec73/workflow.jpg 180w,\n/static/17669f0ded66811bfb3c6e3b71fa1b79/158ba/workflow.jpg 360w,\n/static/17669f0ded66811bfb3c6e3b71fa1b79/80e3c/workflow.jpg 720w,\n/static/17669f0ded66811bfb3c6e3b71fa1b79/47311/workflow.jpg 1080w,\n/static/17669f0ded66811bfb3c6e3b71fa1b79/644c5/workflow.jpg 1440w,\n/static/17669f0ded66811bfb3c6e3b71fa1b79/9f7d8/workflow.jpg 1624w"\n        sizes="(max-width: 720px) 100vw, 720px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",s.createElement(a.h3,null,"2.3 Evaluation"),"\n",s.createElement(a.p,null,"Class pre-initialization extends shared GC heap, it’s a sub-phase of AppCDS dump time workflow, the following performance evaluation concerns AppCDS(Deep blue one) and AppCDS with Class pre-initialization(Green one). We found that about ",s.createElement(a.em,null,"90% (1800/2000) of classes can be pre-initialized safely in a better scenario"),", and ",s.createElement(a.em,null,"average startup performance is improved by 19.2%"),". In a larger-scale evaluation, we found that ",s.createElement(a.em,null,"class pre-initialization is slightly better than AppCDS, with a 5% performance improvement"),"."),"\n",s.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/063cf8579701c9aeb9e7cd4aab49436f/caf7d/evaluation.jpg"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 50.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIDAQX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB76bBLCh//8QAGhAAAgIDAAAAAAAAAAAAAAAAAQIAERIxMv/aAAgBAQABBQKMaVWyEGk5/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGBAAAwEBAAAAAAAAAAAAAAAAABARAQL/2gAIAQEABj8CKXF0v//EABkQAQEBAQEBAAAAAAAAAAAAAAEAETEhQf/aAAgBAQABPyG0BAfJvsTgdjhzy//aAAwDAQACAAMAAAAQW9//xAAWEQEBAQAAAAAAAAAAAAAAAAABACH/2gAIAQMBAT8QWNL/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPxAn/8QAGxABAQEAAgMAAAAAAAAAAAAAAREAITFBUXH/2gAIAQEAAT8Q8agSEaerrUQpSOrZeJjjwKpPmI4BOg3/2Q==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="evaluation"\n        title=""\n        src="/static/063cf8579701c9aeb9e7cd4aab49436f/80e3c/evaluation.jpg"\n        srcset="/static/063cf8579701c9aeb9e7cd4aab49436f/4ec73/evaluation.jpg 180w,\n/static/063cf8579701c9aeb9e7cd4aab49436f/158ba/evaluation.jpg 360w,\n/static/063cf8579701c9aeb9e7cd4aab49436f/80e3c/evaluation.jpg 720w,\n/static/063cf8579701c9aeb9e7cd4aab49436f/caf7d/evaluation.jpg 784w"\n        sizes="(max-width: 720px) 100vw, 720px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",s.createElement(a.p,null,"This is because some classes with high time consumption on initialization usually have side effects. They cannot be pre-initialized, but the pre-initialization mechanism of these classes will still be performed in common paths, and these hot paths will cause a performance penalty."),"\n",s.createElement(a.h2,null,"3. Conclusion"),"\n",s.createElement(a.p,null,"There have been three carriages for Java quick start for a long time: OpenJDK CRaC, JVM Runtime optimizations(AppCDS-based optimizations, AOT, JarIndex, etc), and static compilation (OpenJDK Leyden). All of them are committed to optimizing Java application startup performance from different directions. Alibaba has achieved good results in the second direction. We will continue moving forward and continuously optimize the startup performance of Java applications."))}var l=function(e={}){const{wrapper:a}=Object.assign({},(0,t.RP)(),e.components);return a?s.createElement(a,e,s.createElement(i,e)):i(e)},A=n(4755),o=n(1197),c=n(5895),r=n(8297),p=n(720),m=n(9694),u=n(548),d=n(1169),g=n(1939),h=n(9122),f=n(279);function b(){return b=Object.assign?Object.assign.bind():function(e){for(var a=1;a<arguments.length;a++){var n=arguments[a];for(var t in n)({}).hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},b.apply(null,arguments)}const k=e=>e.dangerouslySetInnerHTML.__html.includes('class="language-text"')?s.createElement("code",e):s.createElement("div",e),E={GuestPost:m.A,blockquote:e=>s.createElement("blockquote",b({style:{paddingLeft:"1.5rem",borderLeft:".3rem solid hsla(0,0%,0%,0.9)"},className:"blockquote"},e)),table:e=>s.createElement("table",b({className:"table table-hover"},e)),thead:e=>s.createElement("thead",b({className:"table-dark"},e)),li:e=>s.createElement("li",b({style:{marginBottom:"1.5em"}},e)),img:e=>s.createElement(f.A,e),div:k},w=({data:e,pageContext:a,location:n,children:i})=>{const l=e.mdx,{previous:c,next:m}=a,f=p[l.frontmatter.author],b=l.frontmatter.tags;return s.createElement(o.A,null,s.createElement("section",{className:"py-5 container"},s.createElement("div",{className:"row py-lg-5"},s.createElement("div",{className:"col-lg-9 col-md-9 mx-auto"},s.createElement("article",null,s.createElement("header",{className:"pb-5"},s.createElement("h1",{className:"mb-0",style:{fontWeight:"900"}},l.frontmatter.title),s.createElement(u.A,{date:l.frontmatter.date,author:f.name,identifier:l.frontmatter.author}),s.createElement(d.A,{location:n,siteMetadata:e.site.siteMetadata,post:l.frontmatter})),s.createElement(t.xA,{components:E},i),s.createElement(g.A,{tags:b}),s.createElement(h.A,null),s.createElement("hr",{className:"p-3"}),s.createElement("footer",{className:"pb-5"},s.createElement(r.Ay,{identifier:l.frontmatter.author,author:f}))),s.createElement("div",null,s.createElement("ul",{style:{display:"flex",flexWrap:"wrap",justifyContent:"space-between",listStyle:"none",padding:0}},s.createElement("li",null,m&&s.createElement(A.Link,{to:m.fields.postPath,rel:"next"},"← ",m.frontmatter.title)),s.createElement("li",null,c&&s.createElement(A.Link,{to:c.fields.postPath,rel:"prev"},c.frontmatter.title," →"))))))))};function y(e){return s.createElement(w,e,s.createElement(l,e))}const v=({data:e})=>{const a=e.mdx;let n="";return a.frontmatter&&a.frontmatter.featuredImage&&(n=a.frontmatter.featuredImage.childImageSharp.gatsbyImageData.images.fallback.src),s.createElement(c.A,{title:a.frontmatter.title,description:a.frontmatter.description||a.excerpt,twitterCard:n})}}}]);
//# sourceMappingURL=component---src-templates-blog-post-tsx-content-file-path-content-blog-a-short-exploration-of-java-class-pre-initialization-index-md-f73c9441c5324dc89753.js.map